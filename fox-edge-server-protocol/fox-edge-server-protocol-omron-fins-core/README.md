# fox-edge-server-protocol-mitsubishi-plc-fx

#### 介绍

``` 
欧姆龙FINS系列
``` 

#### 协议特点

``` 
启动阶段要跟设备先发起连接，然后再通信
所以，Channel层面新增了Linker特性来支持这种“面向简单连接的设备“
这类设备的特点：
启动阶段要跟设备先建立连接，然后再进行通信，中间要不停的发送心跳报文，用来保持连接，然后在连接上进行业务会话类的通信。

实际上它们的通信模型依然为OSI七层模型
会话层<---------------------------->会话层
链路层<---------------------------->链路层
传输层<----------原始报文------------>传输层

所以，Channel层面新增了Linker特性来支持这种“面向简单连接的设备“
1、Channel层面打开Linker特性后，会去加载解码器Jar包的FoxEdgeDeviceType注解标识的类型，找到需要的编码函数
2、Channel层面有连接线程和心跳线程，分别使用编码/解码函数进行建立连接和心跳维持
3、Channel层面的北线API接口，会拦截应用层面发送给设备的数据，进行连接状态的验证和连接的自动建立
4、应用层面旧不需要关心链路的建立和维护的事情，只需进行对设备进行其他命令的处理。
``` 

#### 报文结构

``` 
报文结构：【 FINS/TCP Header】+【FINS Header】+【FINS Command】
其中
1、【 FINS/TCP Header】的结构：【FINS】+【命令长度】+【命令码】+【错误码】
        共12字节               4字节      4字节     4字节     4字节
2、【FINS Header】的结构：ICF RSV GCT DNA DA1 DA2 SNA SA1 SA2 SID
        共10字节          1   1   1   1   1   1   1   1   1   1
3、【FINS Command】的结构：【FINS主命令】+【FINS从命令】+【数据】
        2+N字节              1字节        1字节      N字节
3.1【数据】按发送和接收格式，分别不同
        发送格式：【寄存器控制位】+【开始字地址】+【开始位地址】+【数值】
         4+N字节    1字节          2字节        1字节 + N字节
        接收格式：【主结束码】+【次结束码】+【数值】
         4+N字节    1字节       1字节    N字节
3.1.1【数值】以2字节为一个单元寄，可以是N个连续单元，长度为2*N字节
         这个数值可以是字符串、整数、个数、浮点数、布尔值
         
例如：
发送报文
【46 49 4E 53】【00 00 00 1A】【 00 00 00 02】【00 00 00 00】【80 00 02 00 0A 00 00 71 00 FF】【 01 】      【01 】      【B1】     【  00 0A 】 【  00    】【00 01】
【    FINS   】【   命令长度  】【    命令码   】【   错误码   】【     10字节FINS Header        】【FINS主命令】【FINS从命令】【寄存器控制位】【开始字地址】【开始位地址】【 数值 】
接收报文
【46 49 4E 53】【00 00 00 18 】【00 00 00 02】【00 00 00 00】【C0 00 02 00 71 00 00 0A 00 FF 】【01】    【 01】  【00 00 00 0C】
【    FINS   】【   命令长度  】【    命令码   】【   错误码   】【     10字节FINS Header        】【主结束码】【次结束码】【   数值    】

对象对应关系
一级报文：OmronFinsPdu，具体实例化为三种具体的一级报文ConnectRequest/ConnectRespond/Transfer
        可以使用一级编码器PduEncoder进行编码/解码
二级报文：Transfer的data可以具体化为ReadDataRequest/WriteDataRequest和Respond/ReadDataRespond/WriteDataRespond
         可以使用二级编码器DataEncoder进行编码/解码
三级报文：WriteDataRequest/ReadDataRespond的data属性，可以使用ValueEncoder进行编码解码
``` 

#### 报文样例

``` 
这是我整理的欧姆龙PLC fins指令读写测试数据，分享给大家，希望能帮助到你。

 

****如果你的电脑装有OMRON SYSMAC OPC Server，请把ETN-UNIT服务关闭，否则发送以下指令时将报错，导致读写不了PLC数据****

 

PLC中，CIO区地址=80H DM区地址=82H WR区地址=B1H。

下面以本机的IP=192.168.1.113 PLC的IP=192.168.1.10 PLC端口=9600为例说明如何使用指令(-->代表用户发送帧,<--代表PLC返回帧)：

 

1、连接PLC

  读取或写入数据前，必须先建立PLC连接，然后发以下握手命令给PLC。例如：

  9:54:53-->46 49 4E 53 00 00 00 0C 00 00 00 00 00 00 00 00 00 00 00 71

  9:54:53<--46 49 4E 53 00 00 00 10 00 00 00 01 00 00 00 00 00 00 00 71 00 00 00 0A

  9:54:53<--连接PLC成功,握手成功!!

 

2、读WR.10.01 布尔型   结果=1(第2位为1)

  9:57:12-->46 49 4E 53 00 00 00 1A 00 00 00 02 00 00 00 00 80 00 02 00 0A 00 00 71 00 FF 01 01 B1 00 0A 00 00 01

  9:57:12<--46 49 4E 53 00 00 00 18 00 00 00 02 00 00 00 00 C0 00 02 00 71 00 00 0A 00 FF 01 01 00 00 19 B3

  9:57:12<--读取成功!! 读取值:19B3(16进制) 0001100110110011(2进制)

 

3、读WR.10.0 整型   结果=12

  9:59:17-->46 49 4E 53 00 00 00 1A 00 00 00 02 00 00 00 00 80 00 02 00 0A 00 00 71 00 FF 01 01 B1 00 0A 00 00 01

  9:59:17<--46 49 4E 53 00 00 00 18 00 00 00 02 00 00 00 00 C0 00 02 00 71 00 00 0A 00 FF 01 01 00 00 00 0C

  9:59:17<--读取成功!! 读取值:000C(16进制) 12(10进制)

 

4：读WR.10.0 双整型   结果=1065025548

  10:00:17-->46 49 4E 53 00 00 00 1A 00 00 00 02 00 00 00 00 80 00 02 00 0A 00 00 71 00 FF 01 01 B1 00 0A 00 00 02

  10:00:17<--46 49 4E 53 00 00 00 1A 00 00 00 02 00 00 00 00 C0 00 02 00 71 00 00 0A 00 FF 01 01 00 00 00 0C 3F 7B

  10:00:17<--读取成功!! 读取值:000C3F7B(16进制) 1065025548(10进制)

 

5、读DM.10.0 浮点型   结果=1.5

  10:02:21-->46 49 4E 53 00 00 00 1A 00 00 00 02 00 00 00 00 80 00 02 00 0A 00 00 71 00 FF 01 01 82 00 0A 00 00 02

  10:02:21<--46 49 4E 53 00 00 00 1A 00 00 00 02 00 00 00 00 C0 00 02 00 71 00 00 0A 00 FF 01 01 00 00 00 00 3F C0

  10:02:21<--读取成功!! 读取值:00003FC0(16进制) 1.5(浮点数)

 

6、读WR.480.0 字符型 长度6位  结果=HJK12345678

  10:05:30-->46 49 4E 53 00 00 00 1A 00 00 00 02 00 00 00 00 80 00 02 00 0A 00 00 71 00 FF 01 01 B1 01 E0 00 00 06

  10:05:30<--46 49 4E 53 00 00 00 22 00 00 00 02 00 00 00 00 C0 00 02 00 71 00 00 0A 00 FF 01 01 00 00 48 4A 4B 31 32 33 34 35 36 37 38 00

  10:05:30<--读取成功!! 读取值:484A4B313233343536373800(16进制) HJK12345678(字符串)

 

7、写WR.10.01 写入值0 布尔型

  10:05:17-->46 49 4E 53 00 00 00 1A 00 00 00 02 00 00 00 00 80 00 02 00 0A 00 00 71 00 FF 01 01 B1 00 0A 00 00 01

  10:05:17<--46 49 4E 53 00 00 00 18 00 00 00 02 00 00 00 00 C0 00 02 00 71 00 00 0A 00 FF 01 01 00 00 00 0F

  10:05:17-->原始值:000F(16进制) 0000000000001111(2进制) 写入值:000D(16进制) 0000000000001101(2进制)

  10:05:17-->46 49 4E 53 00 00 00 1C 00 00 00 02 00 00 00 00 80 00 02 00 0A 00 00 71 00 00 01 02 B1 00 0A 00 00 01 00 0D

  10:05:17<--46 49 4E 53 00 00 00 16 00 00 00 02 00 00 00 00 C0 00 02 00 71 00 00 0A 00 00 01 02 00 00

  10:05:17<--写入成功!!

 

8、写WR.10.0 写入值6 整型

  10:06:46-->写入值:6(10进制) 0006(16进制)

  10:06:46-->46 49 4E 53 00 00 00 1C 00 00 00 02 00 00 00 00 80 00 02 00 0A 00 00 71 00 00 01 02 B1 00 0A 00 00 01 00 06

  10:06:46<--46 49 4E 53 00 00 00 16 00 00 00 02 00 00 00 00 C0 00 02 00 71 00 00 0A 00 00 01 02 00 00

  10:06:46<--写入成功!!

 

9、写WR.10.0 写入值1065025588 双整型  

  10:08:16-->写入值:1065025588(10进制) 3F7B0034(16进制)

  10:08:16-->46 49 4E 53 00 00 00 1C 00 00 00 02 00 00 00 00 80 00 02 00 0A 00 00 71 00 00 01 02 B1 00 0A 00 00 01 00 34

  10:08:16<--46 49 4E 53 00 00 00 16 00 00 00 02 00 00 00 00 C0 00 02 00 71 00 00 0A 00 00 01 02 00 00

  10:08:16<--写入成功!!

  10:08:16-->46 49 4E 53 00 00 00 1C 00 00 00 02 00 00 00 00 80 00 02 00 0A 00 00 71 00 00 01 02 B1 00 0B 00 00 01 3F 7B

  10:08:16<--46 49 4E 53 00 00 00 16 00 00 00 02 00 00 00 00 C0 00 02 00 71 00 00 0A 00 00 01 02 00 00

  10:08:16<--写入成功!!

 

10、写DM.10.0 写入值0.68 浮点型  

  10:11:32-->写入值:0.68(浮点数) 7B142E3F(16进制)

  10:11:32-->46 49 4E 53 00 00 00 1C 00 00 00 02 00 00 00 00 80 00 02 00 0A 00 00 71 00 00 01 02 82 00 0A 00 00 01 14 7B

  10:11:32<--46 49 4E 53 00 00 00 16 00 00 00 02 00 00 00 00 C0 00 02 00 71 00 00 0A 00 00 01 02 00 00

  10:11:32<--写入成功!!

  10:11:32-->46 49 4E 53 00 00 00 1C 00 00 00 02 00 00 00 00 80 00 02 00 0A 00 00 71 00 00 01 02 82 00 0B 00 00 01 3F 2E

  10:11:32<--46 49 4E 53 00 00 00 16 00 00 00 02 00 00 00 00 C0 00 02 00 71 00 00 0A 00 00 01 02 00 00

  10:11:32<--写入成功!!

 

11、写WR.480.0 写入值HJK12345678 字符型

  10:17:02-->写入值:HJK12345678(字符串) 484A4B313233343536373800(16进制)

  10:17:02-->46 49 4E 53 00 00 00 1C 00 00 00 02 00 00 00 00 80 00 02 00 0A 00 00 71 00 00 01 02 B1 01 E0 00 00 01 48 4A

  10:17:02<--46 49 4E 53 00 00 00 16 00 00 00 02 00 00 00 00 C0 00 02 00 71 00 00 0A 00 00 01 02 00 00

  10:17:02<--写入成功!!

  10:17:02-->46 49 4E 53 00 00 00 1C 00 00 00 02 00 00 00 00 80 00 02 00 0A 00 00 71 00 00 01 02 B1 01 E1 00 00 01 4B 31

  10:17:02<--46 49 4E 53 00 00 00 16 00 00 00 02 00 00 00 00 C0 00 02 00 71 00 00 0A 00 00 01 02 00 00

  10:17:02<--写入成功!!

  10:17:02-->46 49 4E 53 00 00 00 1C 00 00 00 02 00 00 00 00 80 00 02 00 0A 00 00 71 00 00 01 02 B1 01 E2 00 00 01 32 33

  10:17:02<--46 49 4E 53 00 00 00 16 00 00 00 02 00 00 00 00 C0 00 02 00 71 00 00 0A 00 00 01 02 00 00

  10:17:02<--写入成功!!

  10:17:02-->46 49 4E 53 00 00 00 1C 00 00 00 02 00 00 00 00 80 00 02 00 0A 00 00 71 00 00 01 02 B1 01 E3 00 00 01 34 35

  10:17:02<--46 49 4E 53 00 00 00 16 00 00 00 02 00 00 00 00 C0 00 02 00 71 00 00 0A 00 00 01 02 00 00

  10:17:02<--写入成功!!

  10:17:02-->46 49 4E 53 00 00 00 1C 00 00 00 02 00 00 00 00 80 00 02 00 0A 00 00 71 00 00 01 02 B1 01 E4 00 00 01 36 37

  10:17:02<--46 49 4E 53 00 00 00 16 00 00 00 02 00 00 00 00 C0 00 02 00 71 00 00 0A 00 00 01 02 00 00

  10:17:02<--写入成功!!

  10:17:02<--完成!!
``` 
